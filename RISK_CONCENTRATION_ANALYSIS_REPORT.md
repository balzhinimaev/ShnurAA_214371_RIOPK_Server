# Отчет: Реализация анализа концентрации рисков

## Общая информация

**Дата реализации:** 12 ноября 2025  
**Коммит:** `6c5986b` - "Add risk concentration analysis feature"  
**Статус:** ✅ Реализовано и протестировано

## Описание функционала

Анализ концентрации рисков позволяет определить удельный вес дебиторской задолженности (ДЗ) по каждому контрагенту в процентах от общей суммы. Это помогает выявить концентрацию рисков и понять, насколько зависим бизнес от крупных должников.

## Реализованные компоненты

### 1. DTO (Data Transfer Object)

**Файл:** `src/application/dtos/reports/risk-concentration.dto.ts`

#### RiskConcentrationCustomerDto
Содержит информацию о контрагенте:
- `customerId` - идентификатор контрагента
- `customerName` - название контрагента
- `customerUnp` - УНП (опционально)
- `totalDebt` - общая задолженность контрагента
- `overdueDebt` - просроченная задолженность
- `invoiceCount` - количество счетов
- `oldestDebtDays` - возраст самой старой задолженности (в днях)
- `percentageOfTotal` - **удельный вес задолженности в процентах от общей суммы ДЗ**

#### RiskConcentrationDto
Содержит результат анализа:
- `customers` - массив контрагентов с их процентными долями
- `summary` - сводная информация:
  - `totalCustomers` - общее количество контрагентов с задолженностью
  - `totalDebt` - общая сумма задолженности
  - `asOfDate` - дата расчета
  - `maxConcentration` - максимальная концентрация (процент самого крупного должника)
  - `top5Concentration` - концентрация топ-5 должников (%)
  - `top10Concentration` - концентрация топ-10 должников (%)

### 2. Use Case

**Файл:** `src/application/use-cases/reports/get-risk-concentration.use-case.ts`

#### GetRiskConcentrationUseCase

**Основная логика:**
1. Получает всех контрагентов с задолженностью через `getAllCustomersWithDebt()`
2. Рассчитывает общую сумму задолженности
3. Вычисляет процент от общей суммы для каждого контрагента
4. Рассчитывает метрики концентрации на основе **всех** контрагентов (независимо от фильтров)
5. Применяет фильтры к списку контрагентов в ответе (если указаны)

**Параметры:**
- `asOfDate` (опционально) - дата расчета (по умолчанию - текущая дата)
- `minPercentage` (опционально) - минимальный процент для фильтрации контрагентов
- `limit` (опционально) - ограничение количества контрагентов в результате

**Особенности реализации:**
- Метрики концентрации рассчитываются на основе всех контрагентов, чтобы показать реальную концентрацию рисков в портфеле
- Фильтры применяются только к списку контрагентов в ответе, но не влияют на метрики
- Все проценты округляются до 2 знаков после запятой

### 3. API Эндпоинт

**Маршрут:** `GET /api/v1/reports/risk-concentration`

**Параметры запроса:**
- `asOfDate` (string, date-time) - Дата расчета
- `minPercentage` (number) - Минимальный процент для фильтрации
- `limit` (integer) - Ограничение количества результатов

**Пример запроса:**
```
GET /api/v1/reports/risk-concentration?minPercentage=10&limit=20
```

**Пример ответа:**
```json
{
  "customers": [
    {
      "customerId": "507f1f77bcf86cd799439011",
      "customerName": "ООО Компания А",
      "customerUnp": "123456789",
      "totalDebt": 50000,
      "overdueDebt": 30000,
      "invoiceCount": 5,
      "oldestDebtDays": 30,
      "percentageOfTotal": 50.0
    },
    {
      "customerId": "507f1f77bcf86cd799439012",
      "customerName": "ООО Компания Б",
      "customerUnp": "987654321",
      "totalDebt": 30000,
      "overdueDebt": 20000,
      "invoiceCount": 3,
      "oldestDebtDays": 20,
      "percentageOfTotal": 30.0
    }
  ],
  "summary": {
    "totalCustomers": 2,
    "totalDebt": 80000,
    "asOfDate": "2024-01-15T00:00:00.000Z",
    "maxConcentration": 50.0,
    "top5Concentration": 80.0,
    "top10Concentration": 80.0
  }
}
```

**Аутентификация:** Требуется Bearer токен

### 4. Интеграция

#### Контроллер
**Файл:** `src/infrastructure/web/express/controllers/report.controller.ts`

Добавлен метод `getRiskConcentration()`:
- Извлекает параметры из query string
- Вызывает use case
- Возвращает результат в формате JSON

#### Роуты
**Файл:** `src/infrastructure/web/express/routes/report.routes.ts`

Добавлен роут с полной Swagger документацией:
- Описание эндпоинта
- Описание параметров
- Описание структуры ответа
- Примеры использования

#### DI Контейнер
**Файл:** `src/infrastructure/di/container.config.ts`

Зарегистрирован `GetRiskConcentrationUseCase` для dependency injection.

## Тестирование

### Unit тесты

**Файл:** `tests/application/use-cases/reports/get-risk-concentration.use-case.spec.ts`

**Покрытие:** 10 тестов, все проходят успешно

**Тестируемые сценарии:**
1. ✅ Пустой результат при отсутствии контрагентов с задолженностью
2. ✅ Корректный расчет процентов для каждого контрагента
3. ✅ Использование текущей даты по умолчанию
4. ✅ Фильтрация по минимальному проценту (`minPercentage`)
5. ✅ Ограничение количества результатов (`limit`)
6. ✅ Расчет метрик концентрации для топ-5 и топ-10
7. ✅ Обработка одного контрагента
8. ✅ Корректное округление процентов
9. ✅ Комбинация фильтров (`minPercentage` + `limit`)
10. ✅ Граничный случай (нулевая задолженность)

**Покрытие кода:**
- Statements: 100%
- Branches: 75%
- Functions: 100%
- Lines: 100%

### Integration тесты

**Файл:** `tests/integration/risk-concentration.integration.test.ts`

**Покрытие:** 9 тестов, все проходят успешно

**Тестируемые сценарии:**
1. ✅ Пустой результат при отсутствии данных
2. ✅ Корректный расчет процентов через API
3. ✅ Параметр `asOfDate`
4. ✅ Исключение оплаченных счетов
5. ✅ Обработка нескольких счетов у одного контрагента
6. ✅ Проверка аутентификации (401 при отсутствии токена)
7. ✅ Фильтрация по `minPercentage` через API
8. ✅ Ограничение результатов через `limit`
9. ✅ Расчет метрик концентрации через API с проверкой точных значений

**Особенности:**
- Используется MongoDB Memory Server для изоляции тестов
- Тесты проверяют реальную работу API через Express
- Проверяются точные значения метрик на основе расчетов

## Статистика изменений

### Новые файлы (4)
- `src/application/dtos/reports/risk-concentration.dto.ts` - 55 строк
- `src/application/use-cases/reports/get-risk-concentration.use-case.ts` - 145 строк
- `tests/application/use-cases/reports/get-risk-concentration.use-case.spec.ts` - 443 строки
- `tests/integration/risk-concentration.integration.test.ts` - 562 строки

### Измененные файлы (3)
- `src/infrastructure/di/container.config.ts` - добавлена регистрация use case
- `src/infrastructure/web/express/controllers/report.controller.ts` - добавлен метод контроллера
- `src/infrastructure/web/express/routes/report.routes.ts` - добавлен роут с документацией

### Общая статистика
- **Всего строк:** +1327
- **Новых файлов:** 4
- **Измененных файлов:** 3
- **Тестов:** 19 (10 unit + 9 integration)

## Использование

### Базовый запрос
```bash
curl -X GET "http://localhost:3001/api/v1/reports/risk-concentration" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### С фильтрами
```bash
curl -X GET "http://localhost:3001/api/v1/reports/risk-concentration?minPercentage=10&limit=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### С датой расчета
```bash
curl -X GET "http://localhost:3001/api/v1/reports/risk-concentration?asOfDate=2024-01-15T00:00:00Z" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Бизнес-логика

### Расчет процентов
Процент каждого контрагента рассчитывается как:
```
percentageOfTotal = (totalDebt / totalDebtAll) * 100
```

Где:
- `totalDebt` - задолженность конкретного контрагента
- `totalDebtAll` - общая задолженность всех контрагентов

### Метрики концентрации

**maxConcentration** - процент самого крупного должника. Показывает максимальную зависимость от одного контрагента.

**top5Concentration** - суммарный процент топ-5 должников. Показывает концентрацию рисков в крупнейших должниках.

**top10Concentration** - суммарный процент топ-10 должников. Показывает общую концентрацию в крупных должниках.

### Интерпретация результатов

- **maxConcentration > 50%** - высокая зависимость от одного контрагента (риск)
- **top5Concentration > 80%** - высокая концентрация в топ-5 (принцип Парето)
- **top10Concentration > 90%** - высокая концентрация в крупных должниках

## Технические детали

### Зависимости
- Использует существующий метод `getAllCustomersWithDebt()` из `IInvoiceRepository`
- Интегрирован с существующей архитектурой проекта (Clean Architecture)
- Использует dependency injection через tsyringe

### Производительность
- Использует MongoDB aggregation pipeline для эффективного расчета
- Фильтрация происходит в памяти после получения данных
- Метрики рассчитываются один раз для всех контрагентов

### Обработка ошибок
- Корректная обработка пустого результата
- Валидация параметров запроса
- Обработка ошибок через Express error middleware

## Дальнейшие улучшения

Возможные улучшения функционала:
1. Добавить сортировку по различным полям
2. Добавить пагинацию для больших объемов данных
3. Добавить экспорт результатов в Excel/CSV
4. Добавить визуализацию метрик концентрации
5. Добавить историю изменения концентрации рисков

## Заключение

Функционал анализа концентрации рисков полностью реализован, протестирован и готов к использованию. Все тесты проходят успешно, код соответствует архитектуре проекта и покрыт тестами.

